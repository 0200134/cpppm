name: ğŸ§± Cpppm Build & Test CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Self-Heal Tests
        run: python3 scripts/self_heal_tests.py

      - name: âš™ï¸ Configure
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

      - name: ğŸ§© Build
        run: cmake --build build --config Release --parallel 4

      - name: ğŸ§ª Run help
        if: runner.os != 'Windows'
        run: ./build/cpppm --help || true
        shell: bash

      - name: ğŸ§ª Run help (Windows)
        if: runner.os == 'Windows'
        run: |
          .\build\Release\cpppm.exe --help || .\build\Debug\cpppm.exe --help || true
        shell: pwsh

      - name: ğŸ§¾ Run CTest
        run: ctest --test-dir build -C Release --output-on-failure
